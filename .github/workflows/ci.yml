name: CI

on:
  pull_request:
  push:

jobs:
  web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        working-directory: apps/web
        run: npm install --no-audit --no-fund
      - name: Install Playwright browsers
        working-directory: apps/web
        run: npx playwright install --with-deps
      - name: Lint
        working-directory: apps/web
        run: npm run lint
      - name: Typecheck
        working-directory: apps/web
        run: npm run typecheck
      - name: Unit tests
        working-directory: apps/web
        run: npm run test:coverage
      - name: E2E smoke tests
        working-directory: apps/web
        run: npm run test:e2e

  bot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        working-directory: apps/bot
        run: npm install --no-audit --no-fund
      - name: Lint
        working-directory: apps/bot
        run: npm run lint
      - name: Typecheck
        working-directory: apps/bot
        run: npm run typecheck
      - name: Tests + coverage
        working-directory: apps/bot
        run: npm run test:coverage

  convex:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        working-directory: convex
        run: npm install --no-audit --no-fund
      - name: Lint
        working-directory: convex
        run: npm run lint
      - name: Tests + coverage
        working-directory: convex
        run: npm run test:coverage

  metrics:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"
      - name: Install scc
        run: go install github.com/boyter/scc/v3@latest
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install lizard
        run: python -m pip install lizard
      - name: Run code metrics
        run: |
          export PATH="$HOME/go/bin:$PATH"
          bash scripts/check-metrics.sh
